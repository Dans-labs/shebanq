{{extend 'layout.html'}}
<input type="text" id="search_contents"/>&nbsp;
<a class="ctrl" href="#" id="search_control">show matches</a>&nbsp;
<a class="ctrl" href="#" id="search_clear">back</a>
<p>Public Queries ({{=qcount['']}})&nbsp;Mute&nbsp;
<a class="ctrl" href="#" id="mute_none">none</a>&nbsp;or&nbsp;
<a class="ctrl" href="#" id="mute_all">all</a>&nbsp;or mute selected below&nbsp;
<a class="ctrl" href="#" id="mute_apply">selected</a>&nbsp;below.
</p>
<div id="public_queries">
<ul>
{{
from markdown import markdown
}}
{{ for oname in sorted(tree): }}
    <li class="jstree-open"><a href="#">{{=oname}} ({{=qcount['o'][oname]}})</a>
        <ul>
{{     for pname in sorted(tree[oname]): }}
            <li><a href="#">{{=pname}} ({{=qcount['p'][oname][pname]}})</a>
                <ul>
{{         for uname in sorted(tree[oname][pname]): }}
                    <li uname="{{=uname}}"><a href="#">{{=uname}} ({{=qcount['u'][oname][pname][uname]}})</a>
                        <ul>
{{             for qid in sorted(tree[oname][pname][uname]):
                    qname = tree[oname][pname][uname][qid]
}}
                            <li qid="{{=qid}}">{{=A(qname, _href=URL('hebrew', 'text', host=True, vars=dict(iid=qid, mr='r', qw='q')))}}
                            </li>
{{             pass }}
                        </ul>
                    </li>
{{         pass }}
                </ul>
            </li>
{{     pass }}
        </ul>
    </li>
{{ pass }}
</ul>
</div>
<script type="text/javascript">

$.cookie.raw = false
$.cookie.json = true
$.cookie.defaults.expires = 30
$.cookie.defaults.path = '/'

var searches = []

$(function () {
        $('#public_queries').jstree({
        "core" : {
            "expand_selected_onload": false,
            "multiple": true,
            "themes": {
                "icons": false,
                "dots": false,
             },
        },
        "plugins": [
            "wholerow",
            "checkbox",
            "sort",
            "search",
            "state",
            "contextmenu",
        ],
        "checkbox": {
            "whole_node" : false,
            "tie_selection": true,
            "keep_selected_style": false,
        },
        "state": {"key": 'mymute'},
        "contextmenu": {
            "select_node" : false,
            "items": function(node, f) {
                var items = {}
                if ('a_attr' in node && 'href' in node.a_attr) {
                    var lnk = node.a_attr.href
                    if (lnk != '#') {
                        items = {
                            'goto': {
                                "label": "go to this query",
                                "action": function() {window.location.href = lnk},
                            },
                            'link': {
                                "label": "get mark down link",
                                "action": function() {
                                    var qname = node.text
                                    var uname = $('#public_queries').jstree(true).get_node(node.parent).li_attr.uname
                                    window.prompt('Press <Cmd-C> and then <Enter> to copy link on clipboard', '['+uname+': '+qname+']('+lnk+')')
                                },
                            },
                        }
                    }
                }
                return items
            },
        },
        "search": {
            "show_only_matches" : false,
            "search_callback" : function(pat, node) {
                var found = false
                var pqo = $('#public_queries').jstree(true)
                var text = pqo.get_text(node).toLowerCase()
                if (text.indexOf(pat.toLowerCase()) >= 0) {
                    found = true
                    searches.push(node)
                }
                return found
            },
        },
    })
})

$('#search_clear').hide()

$('#search_control').click(function() {
    pat = $('#search_contents').val()
    if (pat == '') {
        $('#search_contents').val('search string')
    }
    else {
        searches = []
        var pqo = $('#public_queries').jstree(true)
        $('#public_queries').jstree(true).search(pat)
        for (i in searches) {
            node = searches[i]
            pqo.open_node(node)
            pqo.draw_children(node)
        }
        $('#search_clear').show()
    }
})

$('#search_clear').click(function() {
    $('#public_queries').jstree(true).clear_search()
    $('#search_clear').hide()
})
function apply_muting() {
    var checked = $('#public_queries').jstree(true).get_checked(true)
    var purechecked = {}
    console.log('length='+checked.length)
    for (i in checked) {
        node = checked[i]
        if ('li_attr' in node && 'qid' in node.li_attr) {
            purechecked[node.li_attr.qid] = 'v'
            console.log('adding '+node.li_attr.qid)
        }
    }
    $.cookie('mymuting', purechecked)
    console.log('cookie mymuting set')
}
$('#mute_none').click(function() {
    $('#public_queries').jstree(true).uncheck_all()
    apply_muting()
})
$('#mute_all').click(function() {
    $('#public_queries').jstree(true).check_all()
    apply_muting()
})
$('#mute_apply').click(function() {
    apply_muting()
})
</script>
